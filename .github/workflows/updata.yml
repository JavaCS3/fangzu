name: Update Assets Data

on:
  workflow_dispatch: {}

jobs:
  update-data:
    runs-on: ubuntu-20.04
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.x"

      - name: Pip install
        run: |
          python3 -m pip install pandas

      - name: Assume AWS role
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-3

      - name: Update data
        env:
          BUCKET: ${{ secrets.BUCKET }}
        run: |
          DB=${{ secrets.DATA_SOURCE }} scripts/s3cp.sh 2022 /tmp/2022
          DEST_DIR=docs/assets/data/sh/2022 scripts/stat.py /tmp/2022/*

      - uses: EndBug/add-and-commit@v9
        with:
          default_author: github_actions
          add: "./docs/assets/data/*.csv --force"
